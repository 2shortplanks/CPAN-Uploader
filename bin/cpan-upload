#!perl
use strict;
use warnings;
use Carp;
use CPAN::Uploader;
use File::Spec;

use Getopt::Long::Descriptive;
$Getopt::Long::Descriptive::MungeOptions = 1;

my %arg;

my $home = $ENV{HOME} || '.';
my $rc   = File::Spec->catfile($home, '.pause');

# Process .pause
open my $pauserc, '<', $rc or die "can't open $rc for reading: $!";

while (<$pauserc>) {
  chomp;
  next unless $_ and $_ !~ /^\s*#/;

  my ($k, $v) = /^\s*(\w+)\s+(.+)$/;
  croak "multiple enties for $k" if $arg{$k};
  $arg{$k} = $v;
}

# Process arguments
my ($opts, $usage) = describe_options(
	"usage: %c [options] file-to-upload",
	( 
		[ "verbose|v" => "Verbose logging" ],
		[ "help|h"    => "This help message" ],
		[ "dry-run"   => "Do not upload anything." ], 
		[],
		[ "user|u=s"    => "Your PAUSE username (which was previously registered with PAUSE" ],
		[ "password|p=s" => "The password to your PAUSE account" ],
		[ "directory|d=s" => "A subdirectory in your CPAN area where the file should be uploaded to" ],
		[ "http-proxy=s" => "URL of the http proxy to use in uploading" ],
	),
);

die $usage if $opts->{help};
die "Please provide a file name.\n".$usage unless my $file = $ARGV[0];

$arg{debug} = 1 if $opts->{verbose};
$arg{subdir} = $opts->{directory} if defined $opts->{directory};

map { $arg{$_} = $opts->{$_} if defined $opts->{$_} } qw(dry_run user password http-proxy);



=begin opts

These are the options from cpan-upload dist, not from this program.

-user <string>

    Your PAUSE username (which you previously registered with PAUSE).
-password <string>

    The password for your PAUSE username.
-directory <string> | -dir <string>

    A subdirectory in your CPAN area where the file should be uploaded to.
-mailto <email>

    Your email address, to include the HTTP request header. This is also used as the password for the ftp upload to PAUSE.
-ftp_gateway <host>

    Specifies the name of the host which has your ftp gateway.
-ftp_proxy <host>

    Specifies the name of the host which has your ftp proxy, if you're behind a firewall.
-http_proxy <URL>

    Specifies the URL for a proxy to use when making HTTP requests.
-non_interactive | -ni

    cpan-upload should not prompt for any missing information (eg password), it should just warn or die, as appropriate.
-help

    Displays a short help message with the OPTIONS section from the cpan-upload documentation.
-doc

    Display the full documentation for cpan-upload.
-verbose

    Turns on verbose information as the script runs.
-debug

    Turns on debugging information. Useful mainly for the developer, it displays the HTTP request and response.
-version

    Display the version number of the cpan-upload script.

=end opts

=cut


CPAN::Uploader->upload_file(
  $file,
  \%arg,
);
